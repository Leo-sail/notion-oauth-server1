# 🚀 Notion OAuth 服务器使用说明

## 📋 项目概述

这是一个完整的Notion OAuth授权服务器，支持本地测试和Vercel云端部署。用于为Coze平台的Notion插件提供OAuth授权功能。

## 📁 项目结构

```
notion-oauth-server/
├── api/                    # Vercel部署用的API端点
│   ├── auth.py            # 授权端点
│   └── callback.py        # 回调处理
├── venv/                  # Python虚拟环境（自动创建）
├── local_server.py        # 本地测试服务器
├── start.sh              # 启动脚本
├── requirements.txt       # Python依赖
├── vercel.json           # Vercel配置
├── .env.example          # 环境变量示例
├── README.md             # 项目说明
└── 使用说明.md            # 本文件
```

## 🔧 快速开始

### 方式一：使用启动脚本（推荐）

1. **配置环境变量**
   ```bash
   # 复制环境变量模板
   cp .env.example .env
   
   # 编辑.env文件，填入你的Notion集成信息
   nano .env
   ```

2. **运行启动脚本**
   ```bash
   ./start.sh
   ```

3. **访问服务器**
   - 打开浏览器访问：http://localhost:5000
   - 点击"开始Notion授权"按钮
   - 完成授权流程

### 方式二：手动启动

1. **创建虚拟环境**
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```

2. **安装依赖**
   ```bash
   pip install flask requests
   ```

3. **设置环境变量**
   ```bash
   export NOTION_CLIENT_ID="your_client_id"
   export NOTION_CLIENT_SECRET="your_client_secret"
   export REDIRECT_URI="http://localhost:5000/oauth/callback"
   ```

4. **启动服务器**
   ```bash
   python local_server.py
   ```

## 🔑 Notion集成配置

### 1. 创建Notion集成

1. 访问 [Notion集成页面](https://www.notion.so/my-integrations)
2. 点击"+ New integration"
3. 填写集成信息：
   - **Name**: 你的集成名称
   - **Logo**: 可选
   - **Associated workspace**: 选择工作区

### 2. 配置OAuth设置

1. 在集成设置页面，找到"OAuth Domain & URIs"部分
2. 添加Redirect URI：
   - 本地测试：`http://localhost:5000/oauth/callback`
   - Vercel部署：`https://your-app.vercel.app/api/callback`
3. 记录Client ID和Client Secret

### 3. 设置权限

在"Capabilities"部分，确保启用以下权限：
- ✅ Read content
- ✅ Update content
- ✅ Insert content

## 🌐 Vercel部署

### 1. 准备代码

项目已包含Vercel部署所需的所有文件：
- `api/auth.py` - 授权端点
- `api/callback.py` - 回调处理
- `vercel.json` - 部署配置
- `requirements.txt` - 依赖列表

### 2. 部署步骤

1. **上传到GitHub**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/yourusername/notion-oauth-server.git
   git push -u origin main
   ```

2. **在Vercel中部署**
   - 访问 [Vercel](https://vercel.com)
   - 导入GitHub项目
   - 配置环境变量
   - 部署项目

3. **配置环境变量**
   在Vercel项目设置中添加：
   - `NOTION_CLIENT_ID`
   - `NOTION_CLIENT_SECRET`
   - `REDIRECT_URI`

## 🔍 测试授权流程

### 本地测试

1. 启动服务器后访问：http://localhost:5000
2. 检查配置状态（应显示"✅ 已配置"）
3. 点击"🚀 开始Notion授权"
4. 在Notion页面完成授权
5. 获取访问令牌

### 验证令牌

获取令牌后，可以测试API调用：

```python
import requests

headers = {
    'Authorization': f'Bearer {access_token}',
    'Notion-Version': '2022-06-28'
}

response = requests.get('https://api.notion.com/v1/users/me', headers=headers)
print(response.json())
```

## 🛠️ 在Coze插件中使用

### 1. 获取访问令牌

- 通过OAuth流程获取`access_token`
- 复制令牌备用

### 2. 在插件中配置

在Coze插件的工具参数中添加：
```json
{
  "name": "notion_token",
  "type": "string",
  "description": "Notion访问令牌",
  "required": true
}
```

### 3. 使用令牌

在插件代码中使用令牌：
```python
def query_notion_database(database_id, notion_token):
    headers = {
        'Authorization': f'Bearer {notion_token}',
        'Notion-Version': '2022-06-28',
        'Content-Type': 'application/json'
    }
    # ... API调用代码
```

## ⚠️ 注意事项

### 安全性

- 🔒 **保护Client Secret**：绝不要在前端代码中暴露
- 🛡️ **使用HTTPS**：生产环境必须使用HTTPS
- 🔄 **令牌管理**：定期轮换访问令牌
- 📝 **访问日志**：监控API访问情况

### 调试技巧

- 📊 **查看日志**：服务器会输出详细的调试信息
- 🔍 **检查配置**：确保环境变量正确设置
- 🌐 **网络问题**：检查防火墙和代理设置
- 📱 **浏览器**：使用无痕模式避免缓存问题

## 🆘 常见问题

### Q: 授权失败怎么办？
A: 检查Client ID、Secret和Redirect URI是否正确配置

### Q: 令牌获取失败？
A: 确认Notion集成权限设置正确，检查API版本兼容性

### Q: 本地服务器启动失败？
A: 检查Python版本（需要3.7+），确保端口5000未被占用

### Q: Vercel部署失败？
A: 检查requirements.txt格式，确认环境变量设置正确

## 📞 技术支持

如果遇到问题，请检查：
1. 环境变量配置
2. Notion集成设置
3. 网络连接状态
4. Python环境版本

---

🎉 **恭喜！** 你已经成功设置了Notion OAuth服务器。现在可以在Coze插件中使用Notion API了！